<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM | liuweidong&#39; blogs</title>
    <meta name="description" content=" ">
    <link rel="icon" href="/icon.png">
    
    <link rel="preload" href="/assets/css/0.styles.6aaa91c1.css" as="style"><link rel="preload" href="/assets/js/app.41696b04.js" as="script"><link rel="preload" href="/assets/js/3.17d86124.js" as="script"><link rel="prefetch" href="/assets/js/10.b7b9026f.js"><link rel="prefetch" href="/assets/js/2.e253449e.js"><link rel="prefetch" href="/assets/js/4.bf7d54d7.js"><link rel="prefetch" href="/assets/js/5.35180e7d.js"><link rel="prefetch" href="/assets/js/6.f627b205.js"><link rel="prefetch" href="/assets/js/7.ea8062fc.js"><link rel="prefetch" href="/assets/js/8.8d93dc3f.js"><link rel="prefetch" href="/assets/js/9.97c03940.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aaa91c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">liuweidong' blogs</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">关于我</a></div><div class="nav-item"><a href="/blogs/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/reading-notes/" class="nav-link">读书笔记</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">关于我</a></div><div class="nav-item"><a href="/blogs/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/reading-notes/" class="nav-link">读书笔记</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blogs/java_basic.html" class="sidebar-link">Java基础</a></li><li><a href="/blogs/jvm.html" aria-current="page" class="active sidebar-link">JVM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/jvm.html#jvm内存区域划分" class="sidebar-link">JVM内存区域划分</a></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#标记算法" class="sidebar-link">标记算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/jvm.html#引用计数法" class="sidebar-link">引用计数法</a></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#gcroot" class="sidebar-link">GCROOT</a></li></ul></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#jvm三色标记漏标如何解决" class="sidebar-link">JVM三色标记漏标如何解决</a></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#垃圾回收器" class="sidebar-link">垃圾回收器</a></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#g1回收器" class="sidebar-link">G1回收器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/jvm.html#rset-、cardtable理解" class="sidebar-link">Rset 、cardTable理解</a></li></ul></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#gc调优" class="sidebar-link">GC调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/jvm.html#cms" class="sidebar-link">CMS</a></li><li class="sidebar-sub-header"><a href="/blogs/jvm.html#g1：" class="sidebar-link">G1：</a></li></ul></li></ul></li><li><a href="/blogs/spring.html" class="sidebar-link">Spring</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="jvm"><a href="#jvm" class="header-anchor">#</a> JVM</h1> <h2 id="jvm内存区域划分"><a href="#jvm内存区域划分" class="header-anchor">#</a> JVM内存区域划分</h2> <h2 id="标记算法"><a href="#标记算法" class="header-anchor">#</a> 标记算法</h2> <h3 id="引用计数法"><a href="#引用计数法" class="header-anchor">#</a> 引用计数法</h3> <h3 id="gcroot"><a href="#gcroot" class="header-anchor">#</a> GCROOT</h3> <h2 id="jvm三色标记漏标如何解决"><a href="#jvm三色标记漏标如何解决" class="header-anchor">#</a> JVM三色标记漏标如何解决</h2> <p><strong>三色标记</strong>：cms和g1在并发标记期间使用的标记算法，使用三种颜色标记对象，黑色：自身和成员变量都已标记 ，灰色：自身标记，成员变量未全部标记， 白色：自身和成员都未标记， 标记结束之后，白色即为垃圾。</p> <p><strong>漏标出现的2个充要条件</strong>：<br>
1.灰色对象在自己扫描完成之前删除了一个白色对象（导致这个白色对象扫描不到）<br>
2.又有一个黑色对象在自己被标记完之后指向了这个白色对象（导致这个白色对象被引用）</p> <p><strong>CMS垃圾回收器的解决方式</strong>：采用写屏障记录增量更新（破坏条件2），即记录新添加引用的关系保存在集合中，在重新标记阶段对集合中的引用进行遍历重新扫描（即黑变灰），因为用重新标记阶段要stw，并且重新扫描这些集合中的黑色对象比较耗时，可能会导致过长时间的stw；</p> <p><strong>G1回收器的解决方式</strong>：采用写屏障+satb（破坏条件1），satb在标记开始时会做一个快照，在并发标记过程中当灰色对象删除白色对象引用时，会记录起来，在并发标记结束后，根据原始快照对这些白色对象为根进行重新扫描（白变灰），但这有个缺点，有可能这些白色对象被删除引用之后没有黑色对象去指向他，导致这个白色对象没有被回收（浮动垃圾），下一次GC回收，但会比增量更新更省时间</p> <p><strong>zgc的解决方式</strong>：采用的是读屏障，因为引用标记或移动时都要先读取，所以通过读屏障操作着色指针能确保gc时读取数据的正确性</p> <h2 id="垃圾回收器"><a href="#垃圾回收器" class="header-anchor">#</a> 垃圾回收器</h2> <p><img src="/assets/img/GarbageCollector.1f363c1e.png" alt="垃圾回收器图"></p> <h2 id="g1回收器"><a href="#g1回收器" class="header-anchor">#</a> G1回收器</h2> <h3 id="rset-、cardtable理解"><a href="#rset-、cardtable理解" class="header-anchor">#</a> Rset 、cardTable理解</h3> <p>jvm存在跨代引用的情况，当老年代引用新生代的时候，新生代被引用的对象是不能被回收的，为了避免这种跨代引用要扫描整个老年代的情况，有了Rset和cardTable。</p> <h4 id="rset"><a href="#rset" class="header-anchor">#</a> Rset</h4> <p>ponit-in结构，每个region都有一个rset，记录了别的region对本region的引用，可以理解为记录了某某region的哪些卡页引用了本region</p> <h4 id="cardtable"><a href="#cardtable" class="header-anchor">#</a> cardtable</h4> <p>ponit-out结构，每个region被划分为512个card页，一个卡页往往存在多个对象，当一个卡页内有一个或一个以上的对象引用了别的region的对象时，这个card就会被标记为1即脏卡</p> <p>在ygc的时候，扫描新生代的region，根据Rset找到哪个region引用的当前这个region，而脏卡是用来更新Rset的，根据脏卡中的引用关系来更新Rset</p> <h2 id="gc调优"><a href="#gc调优" class="header-anchor">#</a> GC调优</h2> <h3 id="cms"><a href="#cms" class="header-anchor">#</a> CMS</h3> <p>查看gc日志 <br>
如果是年轻代回收次数很多，可以调整年轻代大小、e区和s区的比值 <br>
如果是晋升失败或者con mode fail，可以调整XX:CMSInitiatingOccupancyFraction  XX:UseCMSCompactAtFullCollection   XX:CMSFullGCsBeforeCompaction <br>
如果是方法区溢出，可以调整元空间大小 <br>
另外老年代吃紧的时候除了参数调整，更多要考虑代码优化，看代码中有没有内存泄露、有没有哪里加载大量数据（考虑使用分页）<br></p> <h3 id="g1："><a href="#g1：" class="header-anchor">#</a> G1：</h3> <p>G1有自适应性，一般只要设置预期停顿时间和堆的最大最小值就可以开始工作，偶尔可以微调参数，调的时候注意几个点 <br>
避免显式指定年轻代大小，因为会覆盖暂停时间目标 <br>
暂停时间目标设置需要权衡，可能会影响吞吐量 <br>
在熟悉mixed gc的情况下，可以调整mixed gc参数<br></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/22/2022, 4:45:06 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blogs/java_basic.html" class="prev">
          Java基础
        </a></span> <span class="next"><a href="/blogs/spring.html">
          Spring
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.41696b04.js" defer></script><script src="/assets/js/3.17d86124.js" defer></script>
  </body>
</html>
