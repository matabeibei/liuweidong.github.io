<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring | liuweidong&#39; blogs</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/icon.png">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/assets/css/0.styles.d6ad21ed.css" as="style"><link rel="preload" href="/assets/js/app.450f64ab.js" as="script"><link rel="preload" href="/assets/js/2.8a2ec094.js" as="script"><link rel="preload" href="/assets/js/13.9955ffaa.js" as="script"><link rel="prefetch" href="/assets/js/10.02ead2d0.js"><link rel="prefetch" href="/assets/js/11.5fa2dfaf.js"><link rel="prefetch" href="/assets/js/12.66c429ff.js"><link rel="prefetch" href="/assets/js/14.33883e63.js"><link rel="prefetch" href="/assets/js/15.0206b8e9.js"><link rel="prefetch" href="/assets/js/3.e2f484c3.js"><link rel="prefetch" href="/assets/js/4.dc2cda7a.js"><link rel="prefetch" href="/assets/js/5.755bb8e0.js"><link rel="prefetch" href="/assets/js/6.c85561d1.js"><link rel="prefetch" href="/assets/js/7.37012543.js"><link rel="prefetch" href="/assets/js/8.3c396f04.js"><link rel="prefetch" href="/assets/js/9.31086732.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6ad21ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">liuweidong' blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="/blogs/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/reading-notes/" class="nav-link">
  读书笔记
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="/blogs/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/reading-notes/" class="nav-link">
  读书笔记
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blogs/java_basic.html" class="sidebar-link">Java基础</a></li><li><a href="/blogs/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/blogs/spring.html" aria-current="page" class="active sidebar-link">Spring</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/spring.html#ioc的流程" class="sidebar-link">IOC的流程</a></li><li class="sidebar-sub-header"><a href="/blogs/spring.html#springboot启动流程" class="sidebar-link">springboot启动流程</a></li><li class="sidebar-sub-header"><a href="/blogs/spring.html#springboot自动配置学习" class="sidebar-link">springboot自动配置学习</a></li><li class="sidebar-sub-header"><a href="/blogs/spring.html#spring-bean的生命周期" class="sidebar-link">spring bean的生命周期</a></li><li class="sidebar-sub-header"><a href="/blogs/spring.html#spring-的aop实现方式理解" class="sidebar-link">spring 的AOP实现方式理解</a></li><li class="sidebar-sub-header"><a href="/blogs/spring.html#spring循环依赖解决方式" class="sidebar-link">spring循环依赖解决方式</a></li></ul></li><li><a href="/blogs/redis.html" class="sidebar-link">Redis</a></li><li><a href="/blogs/Mysql.html" class="sidebar-link">Mysql</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring"><a href="#spring" class="header-anchor">#</a> Spring</h1> <h2 id="ioc的流程"><a href="#ioc的流程" class="header-anchor">#</a> IOC的流程</h2> <p><strong>流程</strong></p> <p>1.先根据配置的资源路径（可以是<code>文件路径</code>、<code>url路径</code>）加载到<code>resource</code>中；</p> <p>2.对<code>resource</code>中的资源文件进行解析，解析成<code>dom对象</code>；</p> <p>3.对<code>dom对象</code>根据spring的xml语义进行解析，解析成<code>BeanDifinition</code>，并把BeanDifinition注册到ioc容器中。这个BeanDifinition就是对bean的定义、依赖描述，如classname、bean类型、init方法销毁方法；</p> <p>4.根据<code>BeanDifinition</code>对bean进行实例化并进行依赖注入。这里有两种场景：a.在调用getBean时获取  b.在ioc初始化完成之后进行（lazy-init=false，默认true）</p> <p><strong>备注</strong>：IOC可以使用BeanDifinition，也可以使用<code>@AutoWired</code>和<code>@Resource</code>，使用<code>@AutoWired</code>和<code>@Resource</code>是ioc容器通过反射找到属性的类型和名称，然后通过类型和名称在容器中查找bean，然后进行依赖注入。</p> <p><code>@AutoWired</code>：默认使用类型来查找，如果要使用名称可以配合Qualifier，允许为null可以设置required为false；</p> <p><code>@Resource</code>：先是用名称查找，如果找不到再用类型进行查找，如果指定了属性名就只会按名称来查找；</p> <p><strong>使用Java代码代替xml配置文件的原理</strong>：<code>@Configuration</code>注解的类就相当于一个XML文件，<code>@Bean</code>注解的方法就相当于xml里面的<code>&lt;bean&gt;</code>标签，<code>@Configuration</code>注解的类在扫描的时候会加载到<code>BeanDifinition</code>，然后<code>ConfigurationClassPostProcessor</code>后置处理器的enhanceConfigurationClasses()会对<code>@Configuration</code>标记的类进行增强：用cglib生成<code>@Configuration</code>注解类的代理类，代理类中对<code>@Bean</code>注解的方法进行了增强，在需要一个@Bean注解定义的bean时，会执行增强后的方法：在容器中查找有没有这个bean，有就直接返回，没有就调用原生方法生成一个bean再返回。从而达到替换xml的目的。</p> <h2 id="springboot启动流程"><a href="#springboot启动流程" class="header-anchor">#</a> springboot启动流程</h2> <h2 id="springboot自动配置学习"><a href="#springboot自动配置学习" class="header-anchor">#</a> springboot自动配置学习</h2> <p>我们整合一些组件的时候，我们会引入一些<code>Starter</code>，这些starter的<code>pom</code>会引入该组件需要的依赖包，其中有一个依赖包是该组件的<code>AutoConfiure</code>包，这个包中有<code>meta-inf/spring.factories</code>文件，这个文件中有配置该组件的自动配置类；</p> <p>springboot启动类中的<code>@EnableAutoConfig</code>注解会扫描所有依赖组件的<code>meta-inf/spring.factories</code>文件（@EnableAutoConfiguration注解内使用到了@import注解来完成导入配置的功能，而EnableAutoConfigurationImportSelector内部则是使用了SpringFactoriesLoader.loadFactoryNames方法进行扫描具有META-INF/spring.factories文件的jar包），加载文件中配置的自动配置类，这些配置类中通过<code>@Configuration</code> 、<code>@Bean</code>注解加载组件的bean到ioc容器中，这些bean需要一些地址端口等配置，（通过PackageImport 可以扫描 AutoConfiure包中的bean），AutoConfiure包中的bean通过<code>@ConfigurationProperties</code>和<code>@EnableConfigurationProperties</code>加载配置文件中配置设置到组件bean的属性中，从而完成自动配置。</p> <h2 id="spring-bean的生命周期"><a href="#spring-bean的生命周期" class="header-anchor">#</a> spring bean的生命周期</h2> <h2 id="spring-的aop实现方式理解"><a href="#spring-的aop实现方式理解" class="header-anchor">#</a> spring 的AOP实现方式理解</h2> <p>AOP的核心实现其实是在执行<code>BeanPostProcessor</code>的<code>postProcessorAfterInitialization()</code>里面实现的，整体流程如下：</p> <p>首先启动类的<code>@EnableAspectJAutoProxy</code>注解会在容器中注入一个<code>AnnotationAwareAspectJAutoProxyCreator</code>的bean，这个bean是实现了BeanPostProcessor的，所以BeanPostProcessor的beanPostProcessorBeforeInstantiation会在拦截所有的bean，然后调用到<code>postProcessorAfterInitialization()</code>，这个方法中会调用<code>wrapIfNecessary()</code>，wrapIfNecessary()中会根据增强器表达式匹配增强器判断是否需要进行代理增强，需要增强就使用proxyFactory传入增强器和目标类，proxyFactory根据是否接口、是否配置cglib来判断使用jdk动态代理还是cglib代理生成代理类并返回，生成完成后再从容器中获取bean时获取到的就是被增强的代理类了。</p> <h2 id="spring循环依赖解决方式"><a href="#spring循环依赖解决方式" class="header-anchor">#</a> spring循环依赖解决方式</h2> <p><strong>核心</strong>：三级缓存</p> <p><strong>核心对象</strong>：</p> <p><code>SingletonObjects</code>： 单例缓存池 里面存放的是完整的对象</p> <p><code>EarlySingletonObjects</code>：  创建中的bean的缓存(提前曝光)</p> <p><code>SingletonFactories</code>：  Map&lt;String, ObjectFactory&lt;?&gt;&gt; 对象工厂</p> <p><strong>流程</strong>：</p> <p>1.先在一级缓存查找</p> <p>2.一级缓存没有去二级缓存查询</p> <p>3.二级缓存没有去三级缓存获取对象工厂，在通过工厂的getObject()创建，此时创建是还没有属性注入的</p> <p>4.然后把创建的对象放到缓存中提前曝光</p> <p>5.完成属性赋值后创建完成再从二级缓存放到一级缓存中，后续获取的就是完整对象</p> <p><strong>举例</strong>：A-&gt;B  B-&gt;A</p> <p>在一级缓存中找A，没有去二级缓存，也没有，去三级缓存获取并放到二级缓存中提前曝光A，然后对属性B注入</p> <p>在一级缓存中找B，没有去二级缓存，也没有，去三级缓存获取并放到二级缓存中提前曝光B，然后B中的属性A注入，一级缓存没有，去二级缓存查找，二级缓存中有提前曝光的A，所以能从二级缓存中获取到A，然后注入，B完成创建就会放到一级缓存中，然后方法返回B回到A的属性注入，给A注入B，此时A也完成创建放入一级缓存，从而解决循环依赖。</p> <p><strong>备注</strong>：三级缓存不能解决【构造注入的循环依赖】和【prototype  field属性注入循环依赖】</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/7/2022, 4:19:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blogs/jvm.html" class="prev">
        JVM
      </a></span> <span class="next"><a href="/blogs/redis.html">
        Redis
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.450f64ab.js" defer></script><script src="/assets/js/2.8a2ec094.js" defer></script><script src="/assets/js/13.9955ffaa.js" defer></script>
  </body>
</html>
